# see thorson and kristensen 2024 chp 3

library(RTMB)

#--------------------------------------------------------------------------------
# read in data, manipulate for analysis
#--------------------------------------------------------------------------------

data <- list(log_b_t = c(
    19.0992348230898, 19.3510092963473, 19.4244616951428, 19.3758252812188,
    19.6542685235477, 19.7277592578208, 20.0660564218032, 19.9915253698302,
    20.1321038198006, 20.0454042876212, 20.2213669743156, 20.1545716105256,
    20.2834436911389, 20.1465312569899, 20.1855304866488, 20.4180433485465,
    20.2945840626075, 19.7462348303586, 19.7506825753769, 20.0040690827552,
    20.1346457655055, 20.0586936131754, 20.2143168686861, 20.2453058567161,
    20.2702569056685, 20.1412619214677, 20.1005558849014, 19.8968162737556,
    20.0251753136686, 20.3640247733185, 19.793937289383, 20.0860886214702,
    20.114664910698, 19.8079632057939, 19.9368822346047, 20.15210722559,
    20.0381645097973, 20.2989137271636
))

#--------------------------------------------------------------------------------
# fit conditional autoregressive state-space Gompertz using RTMB
#--------------------------------------------------------------------------------

par <- list(
    "log_d0" = c(0, 0),
    "log_sdp" = 1,
    "log_sdo" = 1,
    "alpha" = 0,
    "rho" = 0,
    "log_d_t" = rep(0, length(data$log_b_t))
)

f <- function(par) {
    getAll(data, par, warn = FALSE)
    log_b_t <- OBS(log_b_t)
    jnll <- 0
    # Pr(random coefficients):
    jnll <- jnll - dnorm(log_d_t[1], log_d0[1], exp(log_sdp), TRUE)
    for (t in 2:length(log_b_t)) {
        jnll <- jnll -
            dnorm(log_d_t[t], alpha + rho * log_d_t[t - 1], exp(log_sdp), TRUE)
    }
    # Pr(data|fixed + random)
    jnll <- jnll - sum(dnorm(log_b_t, log_d_t, exp(log_sdo), TRUE))
    jnll
}

obj <- MakeADFun(f, par, random = "log_d_t")
opt <- nlminb(obj$par, obj$fn, obj$gr)
opt
sdr <- sdreport(obj)
sdr
